import React, { useEffect, useRef, useState, useCallback, useMemo } from 'react'
import { FiArrowRight, FiBookOpen, FiCommand, FiGlobe, FiLoader } from 'react-icons/fi'
import Link from 'next/link'
import createGlobe from 'cobe'
import { useSpring } from 'react-spring'
import { GoStar, GoRepoForked, GoRepo, GoEye } from 'react-icons/go'
import { getGitHubStates, useFollowPointer } from '../utils'
import { motion, AnimatePresence } from 'framer-motion'
import { FaReact } from 'react-icons/fa'
import { MdOutlineScience } from 'react-icons/md'
import { SiNestjs } from 'react-icons/si'
import { Logo } from '../theme.config'
import { Stacks } from '../components/TextSwiper'
import { frontEnd, OtherStacks } from '../components/TextSwiper/data'
import TextTurn from '../components/TextTurn'
import Visitors from '../components/Visitor'
import VisitorCard from '../components/Visitor/VisitorCard'
import CloudVanta from 'vanta/dist/vanta.clouds.min'
import * as THREE from 'three'
import { useTheme } from 'nextra-theme-docs'

export function Cloud () {
  const [vantaEffect, setVantaEffect] = useState(null)
  const [isVisible, setIsVisible] = useState(false)
  const [useSimpleMode, setUseSimpleMode] = useState(false)
  const vantaRef = useRef(null)
  const { theme } = useTheme()
  const initTimeoutRef = useRef(null)

  // 简单的设备检测
  const isLowEndDevice = useMemo(() => {
    if (typeof window === 'undefined') return false
    
    const checks = [
      navigator.hardwareConcurrency <= 2, // CPU核心数少于等于2
      navigator.deviceMemory && navigator.deviceMemory <= 2, // 内存少于等于2GB
      /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent), // 移动设备
      window.devicePixelRatio <= 1, // 低像素比屏幕
      navigator.connection && ['slow-2g', '2g', '3g'].includes(navigator.connection.effectiveType) // 慢网络
    ]
    
    // 满足2个或以上条件就认为是低端设备
    const lowEndIndicators = checks.filter(Boolean).length
    const isLowEnd = lowEndIndicators >= 2
    
    if (process.env.NODE_ENV === 'development') {
      console.log('Device detection:', {
        hardwareConcurrency: navigator.hardwareConcurrency,
        deviceMemory: navigator.deviceMemory,
        isMobile: /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
        devicePixelRatio: window.devicePixelRatio,
        connectionType: navigator.connection?.effectiveType,
        lowEndIndicators,
        isLowEnd
      })
    }
    
    return isLowEnd
  }, [])

  // 使用 Intersection Observer 来检测组件是否可见
  useEffect(() => {
    const observer = new IntersectionObserver(
      ([entry]) => {
        setIsVisible(entry.isIntersecting)
      },
      {
        threshold: 0.1,
        rootMargin: '50px'
      }
    )

    if (vantaRef.current) {
      observer.observe(vantaRef.current)
    }

    return () => {
      if (vantaRef.current) {
        observer.unobserve(vantaRef.current)
      }
    }
  }, [])

  // 简化的配置参数
  const vantaConfig = useMemo(() => {
    if (isLowEndDevice) {
      // 低端设备使用最简配置
      return {
        el: vantaRef.current,
        mouseControls: false,
        touchControls: false,
        gyroControls: false,
        minHeight: 300,
        minWidth: 200,
        backgroundColor: theme === 'dark' ? 0x0 : 0xffffff,
        skyColor: theme === 'dark' ? 0x141718 : 0xaad5e5,
        cloudColor: theme === 'dark' ? 0x7b7b8e : 0xadc4de,
        speed: 0.5, // 极低速度
        cloudSize: 0.6,
        scale: 0.5,
        scaleMobile: 0.3,
        zoom: 1.5,
        mouseEase: false,
        cloudDensity: 0.005, // 极低密度
        cloudDepth: 5,
        quantity: 1, // 只有1个云朵
        showDots: false,
        THREE
      }
    } else {
      // 普通设备使用中等配置
      return {
        el: vantaRef.current,
        mouseControls: true,
        touchControls: true,
        gyroControls: false,
        minHeight: 300,
        minWidth: 200,
        backgroundColor: theme === 'dark' ? 0x0 : 0xffffff,
        skyColor: theme === 'dark' ? 0x141718 : 0xaad5e5,
        cloudColor: theme === 'dark' ? 0x7b7b8e : 0xadc4de,
        sunColor: theme === 'dark' ? 0x654826 : 0xff9c21,
        speed: theme === 'dark' ? 1.0 : 0.8,
        cloudSize: 0.8,
        scale: 0.7,
        scaleMobile: 0.5,
        zoom: 1.1,
        mouseEase: false,
        cloudDensity: theme === 'dark' ? 0.015 : 0.01,
        cloudDepth: 15,
        quantity: theme === 'dark' ? 3 : 2,
        showDots: false,
        THREE
      }
    }
  }, [theme, isLowEndDevice])

  // 简化的初始化函数
  const initEffect = useCallback(() => {
    // 如果是低端设备且已经有3秒没成功初始化，使用简单模式
    if (isLowEndDevice && !vantaEffect) {
      const timer = setTimeout(() => {
        setUseSimpleMode(true)
      }, 3000)
      
      if (useSimpleMode) {
        clearTimeout(timer)
        return
      }
    }

    if (!isVisible || typeof window === 'undefined' || !vantaRef.current || useSimpleMode) return

    // 清理之前的超时
    if (initTimeoutRef.current) {
      clearTimeout(initTimeoutRef.current)
    }

    initTimeoutRef.current = setTimeout(() => {
      try {
        // 清理之前的效果实例
        if (vantaEffect) {
          vantaEffect.destroy()
          setVantaEffect(null)
        }

        // 创建新的效果实例
        const effect = CloudVanta(vantaConfig)
        
        if (effect) {
          setVantaEffect(effect)
          
          // 在低端设备上大幅降低渲染质量
          if (effect.renderer && isLowEndDevice) {
            effect.renderer.setPixelRatio(0.3) // 极低像素比
            effect.renderer.antialias = false
            effect.renderer.precision = 'lowp'
            effect.renderer.powerPreference = 'low-power'
          }
        }
      } catch (error) {
        console.warn('Cloud effect failed, switching to simple mode:', error)
        setUseSimpleMode(true)
      }
    }, isLowEndDevice ? 500 : 100)
  }, [isVisible, vantaConfig, vantaEffect, isLowEndDevice, useSimpleMode])

  useEffect(() => {
    initEffect()
    
    return () => {
      if (initTimeoutRef.current) {
        clearTimeout(initTimeoutRef.current)
      }
      
      if (vantaEffect) {
        try {
          vantaEffect.destroy()
        } catch (error) {
          console.warn('Error cleaning up vanta effect:', error)
        }
      }
    }
  }, [initEffect])

  // 当组件不可见时暂停动画
  useEffect(() => {
    if (vantaEffect && vantaEffect.renderer) {
      if (isVisible) {
        vantaEffect.renderer.setAnimationLoop(vantaEffect.animationLoop)
      } else {
        vantaEffect.renderer.setAnimationLoop(null)
      }
    }
  }, [isVisible, vantaEffect])

  // 如果使用简单模式，显示静态背景
  if (useSimpleMode || isLowEndDevice) {
    return (
      <motion.div 
        className={'h-[15rem] w-full rounded-2xl flex overflow-hidden relative'}
        style={{
          background: theme === 'dark' 
            ? 'linear-gradient(135deg, #141718 0%, #2a3f5f 100%)'
            : 'linear-gradient(135deg, #aad5e5 0%, #87ceeb 100%)'
        }}
      >
        <div className={'w-full h-full flex justify-center items-center'}>
          <motion.div 
            className={'font-bold text-4xl nx-font-mono text-white dark:text-gray-500 z-10 relative'}
            animate={{ opacity: [0.7, 1, 0.7] }}
            transition={{ repeat: Infinity, duration: 3 }}
          >
            Dream on the sky
          </motion.div>
        </div>
      </motion.div>
    )
  }

  return (
    <motion.div 
      className={'h-[15rem] w-full rounded-2xl flex overflow-hidden relative'}
      whileHover={{ 
        scale: 1.01,
        transition: { duration: 0.3, ease: "easeOut" }
      }}
    >
      <div 
        ref={vantaRef} 
        className={'w-full h-full flex justify-center items-center'}
      >
        <motion.div 
          className={'font-bold text-4xl nx-font-mono text-white dark:text-gray-500 z-10 relative'}
          animate={isVisible ? { opacity: [0.7, 1, 0.7] } : { opacity: 0.7 }}
          transition={isVisible ? { repeat: Infinity, duration: 2.5 } : { duration: 0.5 }}
        >
          Dream on the sky
        </motion.div>
      </div>
    </motion.div>
  )
}

export function TopTag () {
  return (
        <div className={'w-max px-3 h-8 gap-2 bg-sky-300 bg-opacity-30 border-2 border-solid border-blue-400 rounded-lg flex justify-center items-center text-center'}>
            <FiLoader className={'animate-spin'} />
          Runing
        </div>
  )

}

export function Button ({ children, href, className }) {
  return (
        <Link href={href} className={'w-max px-4 py-3 md:px-6 md:py-3 font-bold bg-blue-200 bg-opacity-30 hover:bg-opacity-80 rounded-lg flex justify-center items-center text-center transition-all duration-300 ease-in-out hover:scale-105 active:scale-95 text-sm md:text-base ' + className}>
            {children}
        </Link>
  )

}

export function CodeModel () {
  const canvasRef = useRef()
  const pointerInteracting = useRef(null)
  const pointerInteractionMovement = useRef(0)
  const [{ r }, api] = useSpring(() => ({
    r: 0,
    config: {
      mass: 1,
      tension: 280,
      friction: 40,
      precision: 0.001
    }
  }))
  useEffect(() => {
    let phi = 0
    let width = 0
    const onResize = () => canvasRef.current && (width = canvasRef.current.offsetWidth)
    window.addEventListener('resize', onResize)
    onResize()
    
    // 移动端检测
    const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768
    
    const globe = createGlobe(canvasRef.current, {
      devicePixelRatio: isMobile ? 1 : 2, // 移动端降低分辨率
      width: width * (isMobile ? 1.5 : 2),
      height: width * (isMobile ? 1.5 : 2),
      phi: 0,
      theta: 0.3,
      dark: 1,
      diffuse: 3,
      mapSamples: isMobile ? 8000 : 16000, // 移动端减少采样
      mapBrightness: 1.2,
      baseColor: [1, 1, 1],
      markerColor: [251 / 255, 100 / 255, 21 / 255],
      glowColor: [1.2, 1.2, 1.2],
      markers: [
        { location: [39.9042, 116.4074], size: 0.05 }
      ],
      onRender: (state) => {
        // This prevents rotation while dragging
        if (!pointerInteracting.current) {
          // Called on every animation frame.
          // `state` will be an empty object, return updated params.
          phi += isMobile ? 0.003 : 0.005 // 移动端较慢旋转
        }
        state.phi = phi + r.get()
        state.width = width * (isMobile ? 1.5 : 2)
        state.height = width * (isMobile ? 1.5 : 2)
      }
    })
    // eslint-disable-next-line no-return-assign
    setTimeout(() => canvasRef.current.style.opacity = '1')
    return () => globe.destroy()
  }, [])
  return <div
    className={'animate-in slide-in-from-bottom ease-in duration-[3s]'}
  style={{
    width: '100%',
    maxWidth: 600,
    aspectRatio: 1,
    margin: 'auto',
    position: 'relative'
  }}>
        <canvas
            ref={canvasRef}
            onPointerDown={(e) => {
              pointerInteracting.current =
                    e.clientX - pointerInteractionMovement.current
              canvasRef.current.style.cursor = 'grabbing'
            }}
            onPointerUp={() => {
              pointerInteracting.current = null
              canvasRef.current.style.cursor = 'grab'
            }}
            onPointerOut={() => {
              pointerInteracting.current = null
              canvasRef.current.style.cursor = 'grab'
            }}
            onMouseMove={(e) => {
              if (pointerInteracting.current !== null) {
                const delta = e.clientX - pointerInteracting.current
                pointerInteractionMovement.current = delta
                api.start({
                  r: delta / 200
                })
              }
            }}
            onTouchMove={(e) => {
              if (pointerInteracting.current !== null && e.touches[0]) {
                const delta = e.touches[0].clientX - pointerInteracting.current
                pointerInteractionMovement.current = delta
                api.start({
                  r: delta / 100
                })
              }
            }}
            style={{
              width: '100%',
              height: '100%',
              cursor: 'grab',
              contain: 'layout paint size',
              opacity: 0,
              transition: 'opacity 1s ease'
            }}
        />
    </div>

}

export function GitHubStats () {
  const [requested, setRequested] = useState(false)
  const [requested2, setRequested2] = useState(false)
  const [stars, setStars] = useState(0)
  const [repos, setRepos] = useState(0)
  const [forks, setForks] = useState(0)
  const [followers, setFollowers] = useState(0)
  const [animatedStars, setAnimatedStars] = useState(0)
  const [animatedRepos, setAnimatedRepos] = useState(0)
  const [animatedForks, setAnimatedForks] = useState(0)
  const [animatedFollowers, setAnimatedFollowers] = useState(0)
  
  useEffect(() => {
    const res = getGitHubStates({ username: 'nansang2000', perpage: 100, pagenum: 2 })
    res.then((res) => {
        setStars(res.totalStars)
        setRepos(res.totalRepos)
        setForks(res.totalForks)
        setRequested(true)
    }).catch((e) => {
      console.log(e)
    })
  }, [requested])

  useEffect(() => {
      // /users/{username}
      fetch('https://api.github.com/users/nansang2000')
        .then((res) => res.json())
        .then((res) => {
          setFollowers(res.followers)
          setRequested2(true)
        }).catch((e) => {
          console.log(e)
        })
  }, [requested2])
  
  // Animation effect for counting up numbers
  useEffect(() => {
    if (stars > 0) {
      const duration = 1500; // ms
      const steps = 20;
      const stepTime = duration / steps;
      const increment = stars / steps;
      let current = 0;
      
      const timer = setInterval(() => {
        current += increment;
        if (current >= stars) {
          setAnimatedStars(stars);
          clearInterval(timer);
        } else {
          setAnimatedStars(Math.floor(current));
        }
      }, stepTime);
      
      return () => clearInterval(timer);
    }
  }, [stars]);
  
  useEffect(() => {
    if (repos > 0) {
      const duration = 1500;
      const steps = 20;
      const stepTime = duration / steps;
      const increment = repos / steps;
      let current = 0;
      
      const timer = setInterval(() => {
        current += increment;
        if (current >= repos) {
          setAnimatedRepos(repos);
          clearInterval(timer);
        } else {
          setAnimatedRepos(Math.floor(current));
        }
      }, stepTime);
      
      return () => clearInterval(timer);
    }
  }, [repos]);
  
  useEffect(() => {
    if (forks > 0) {
      const duration = 1500;
      const steps = 20;
      const stepTime = duration / steps;
      const increment = forks / steps;
      let current = 0;
      
      const timer = setInterval(() => {
        current += increment;
        if (current >= forks) {
          setAnimatedForks(forks);
          clearInterval(timer);
        } else {
          setAnimatedForks(Math.floor(current));
        }
      }, stepTime);
      
      return () => clearInterval(timer);
    }
  }, [forks]);
  
  useEffect(() => {
    if (followers > 0) {
      const duration = 1500;
      const steps = 20;
      const stepTime = duration / steps;
      const increment = followers / steps;
      let current = 0;
      
      const timer = setInterval(() => {
        current += increment;
        if (current >= followers) {
          setAnimatedFollowers(followers);
          clearInterval(timer);
        } else {
          setAnimatedFollowers(Math.floor(current));
        }
      }, stepTime);
      
      return () => clearInterval(timer);
    }
  }, [followers]);

  return (
        <motion.div 
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.7, delay: 0.3 }}
          className={'w-full h-full flex flex-col md:flex-row justify-center md:justify-start items-center gap-3 md:gap-5'}
        >
            <div className={'flex flex-col items-center md:items-start'}>
              <div className={'text-xs md:text-sm lg:text-base flex h-max justify-center items-center text-black'}>
                Stars Earned
              </div>
              <div className={'text-lg md:text-xl lg:text-2xl gap-1 md:gap-2 flex h-max justify-center md:justify-start items-center text-black'}>
                <GoStar className={'text-blue-500'} /> {animatedStars}
              </div>
            </div>
          <div className={'flex flex-col items-center md:items-start'}>
            <div className={'text-xs md:text-sm lg:text-base flex h-max justify-center items-center text-black'}>
              Forks Earned
            </div>
            <div className={'text-lg md:text-xl lg:text-2xl gap-1 md:gap-2 flex h-max justify-center md:justify-start items-center text-black'}>
              <GoRepoForked className={'text-blue-500'} /> {animatedForks}
            </div>
          </div>
          <div className={'flex flex-col items-center md:items-start'}>
            <div className={'text-xs md:text-sm lg:text-base flex h-max justify-center items-center text-black'}>
              Repositories
            </div>
            <div className={'text-lg md:text-xl lg:text-2xl gap-1 md:gap-2 flex h-max justify-center md:justify-start items-center text-black'}>
              <GoRepo className={'text-blue-500'} /> {animatedRepos}
            </div>
          </div>
          <div className={'flex flex-col items-center md:items-start'}>
            <div className={'text-xs md:text-sm lg:text-base flex h-max justify-center items-center text-black'}>
              Followers
            </div>
            <div className={'text-lg md:text-xl lg:text-2xl gap-1 md:gap-2 flex h-max justify-center md:justify-start items-center text-black'}>
              <GoEye className={'text-blue-500'} /> {animatedFollowers}
            </div>
          </div>
        </motion.div>
    )
  
}

export function WakaTime () {

  return (
    <div>
      Waka
    </div>
  )
}

<motion.div 
  initial={{ opacity: 0, scale: 0.8 }}
  animate={{ opacity: 0.1, scale: 1 }}
  transition={{ duration: 1.5 }}
  className={'h-96 w-3/4 bg-gradient-to-r -z-10 from-blue-500 to-red-800 absolute right-0 top-32 opacity-10 dark:opacity-20 !blur-3xl rounded-full'}
></motion.div>
<div className={'lg:grid lg:grid-cols-2 z-10'}>
    <div className={'w-full h-max py-6 md:py-12 mt-16 md:mt-28'}>
        <motion.div
          initial={{ opacity: 0, y: -20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5 }}
        >
          <TopTag />
        </motion.div>
        <motion.div 
          className={'flex h-max text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-bold w-full justify-start items-center mt-2 lg:-mt-3'}
          initial={{ opacity: 0, x: -30 }}
          animate={{ opacity: 1, x: 0 }}
          transition={{ duration: 0.7, delay: 0.2 }}
        >
            <div>I'm&nbsp;</div>
            <div className={'linear-gradient-text leading-loose'}>Nan&nbsp;</div>
            <div>Sang</div>
        </motion.div>
        <motion.div 
          className={'text-lg sm:text-xl md:text-2xl lg:text-4xl font-bold text-gray-600 dark:text-gray-320 mt-2 md:-mt-2 leading-relaxed'}
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ duration: 0.7, delay: 0.4 }}
        >
            An energetic <b className={'underline decoration-wavy underline-offset-2 decoration-blue-500'}>Data Science</b> learner.
        </motion.div>
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5, delay: 0.6 }}
        >
          <Button href={'/note'} className={'mt-4 md:mt-6'}>
              Get Started
          </Button>
        </motion.div>

        [//]: # (<img className={'mt-10 h-20'} src="https://ghchart.rshah.org/409ba5/nansang2000" alt="GitHub Nan Sang" />)
    </div>
    <div className={'w-full h-max py-6 md:py-12 mt-4 lg:mt-8'}>
        <img alt={'banner'} className={'w-full h-full max-w-md mx-auto lg:max-w-none'} src={'/banner.svg'} />
    </div>
</div>

<div className={'my-3'}>
  <Cloud/>
</div>

<motion.div 
  initial={{ opacity: 0 }}
  animate={{ opacity: 1 }}
  transition={{ duration: 0.8, delay: 0.8 }}
  className={'w-full flex flex-col lg:grid lg:grid-flow-row-dense lg:grid-cols-5 gap-3 md:gap-2'}
>
    <motion.div
        whileHover={{ scale: 1.02 }}
        transition={{ type: "spring", stiffness: 300 }}
        className={'flex p-4 md:p-3 justify-center relative overflow-hidden items-center bg-white col-span-3 h-64 md:h-96 w-full rounded-2xl forest-bg'}
    >
        <div className={'bg-black dark:bg-white dark:bg-black absolute w-full h-full opacity-30 '}></div>
        <motion.div 
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5, delay: 1 }}
          className={'font-bold text-lg xs:text-xl md:text-2xl lg:text-2xl text-white dark:text-black z-10 underline decoration-emerald-400 underline-offset-4 leading-relaxed text-center px-2'}
        >
           Data Scientist | Test Engineer | Software Engineer | Product Manager .
        </motion.div>
    </motion.div>
    <motion.div 
        whileHover={{ scale: 1.02 }}
        transition={{ type: "spring", stiffness: 300 }}
        className={'flex h-64 md:h-96 w-full justify-center items-center lg:col-span-2 shadow-inner relative bg-gray-600 dark:bg-gray-900 rounded-2xl overflow-hidden'}
    >
        <CodeModel />
        <motion.div 
          initial={{ opacity: 0 }}
          animate={{ opacity: 0.3 }}
          transition={{ duration: 0.8, delay: 1.2 }}
          className={'absolute w-full flex justify-center items-center z-0 text-white text-lg xs:text-xl md:text-2xl lg:text-4xl font-bold px-4 text-center'}
        >
            Now in Beijing, China.
        </motion.div>
    </motion.div>
</motion.div>

<motion.div 
  initial={{ opacity: 0 }}
  animate={{ opacity: 1 }}
  transition={{ duration: 0.8, delay: 1.2 }}
  className={'w-full flex flex-col lg:grid lg:grid-flow-row-dense lg:grid-cols-5 gap-3 md:gap-2 my-3'}
>
    <motion.div 
      whileHover={{ scale: 1.02 }}
      transition={{ type: "spring", stiffness: 300 }}
      className={'flex relative overflow-hidden bg-gray-800 col-span-2 h-80 md:h-96 w-full rounded-2xl code-bg'}
    >
        <div className={'bg-black bg-gray-900 absolute w-full h-full opacity-80 z-0'}></div>
        <div className={'h-full z-10 p-4 md:p-6 grid w-full items-stretch content-start'}>
            <motion.div 
              initial={{ opacity: 0, y: -20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.5, delay: 1.4 }}
              className={'text-2xl md:text-3xl font-bold text-white underline decoration-orange-600 underline-offset-4'}
            >
                About me
            </motion.div>
            <div className={'flex w-full flex-col space-y-3 mt-3'}>
              <motion.div 
                initial={{ opacity: 0, x: -30 }}
                animate={{ opacity: 1, x: 0 }}
                transition={{ duration: 0.5, delay: 1.6 }}
                className={'w-full bg-gray-800 px-3 py-3 bg-opacity-90 rounded-md flex justify-between items-center'}
              >
                    <FiCommand className={'text-xl md:text-2xl text-white flex-shrink-0'} />
                    <div className={'text-white font-bold text-sm md:text-base lg:text-lg ml-3'}>
                        A <b className={'text-red-600'}>full-stack developer.</b>
                    </div>
              </motion.div>
              <motion.div 
                initial={{ opacity: 0, x: -30 }}
                animate={{ opacity: 1, x: 0 }}
                transition={{ duration: 0.5, delay: 1.8 }}
                className={'w-full bg-gray-800 px-3 py-3 bg-opacity-90 rounded-md flex justify-between items-center'}
              >
                    <FiGlobe className={'text-xl md:text-2xl text-white flex-shrink-0'} />
                    <div className={'text-white font-bold text-sm md:text-base lg:text-lg ml-3'}>
                        Now Studying at <b className={'text-blue-600'}>Unimelb.</b>
                    </div>
                </motion.div>
              <motion.div 
                initial={{ opacity: 0, x: -30 }}
                animate={{ opacity: 1, x: 0 }}
                transition={{ duration: 0.5, delay: 2.0 }}
                className={'w-full bg-gray-800 px-3 py-3 bg-opacity-90 rounded-md flex justify-between items-center'}
              >
                    <FiBookOpen className={'text-xl md:text-2xl text-white flex-shrink-0'} />
                    <div className={'text-white font-bold text-sm md:text-base lg:text-lg ml-3'}>
                        Major in <b className={'text-orange-600'}>Data Science.</b>
                    </div>
                </motion.div>
            </div>
        </div>
    </motion.div>
    <motion.div 
      whileHover={{ scale: 1.02 }}
      transition={{ type: "spring", stiffness: 300 }}
      className={'flex relative overflow-hidden bg-blue-100 col-span-3 h-max min-h-80 lg:h-96 w-full rounded-2xl'}
    >
        <div className={'bg-black bg-gray-300 absolute w-full h-full opacity-80 z-0 backdrop-blur-lg'}></div>
        <motion.div 
          initial={{ opacity: 0, scale: 0.5 }}
          animate={{ opacity: 0.8, scale: 1 }}
          transition={{ duration: 1.5, delay: 1.4 }}
          className={'w-96 h-96 bg-orange-300 rounded-full absolute blur-3xl left-24'}
        ></motion.div>
        <motion.div 
          initial={{ opacity: 0, scale: 0.5 }}
          animate={{ opacity: 0.8, scale: 1 }}
          transition={{ duration: 1.5, delay: 1.6 }}
          className={'w-96 h-96 bg-pink-200 rounded-full absolute blur-3xl right-24'}
        ></motion.div>
        <div className={'h-full z-10 p-4 md:p-6 grid w-full items-stretch content-start'}>
            <motion.div 
              initial={{ opacity: 0, y: -20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.5, delay: 1.4 }}
              className={'text-2xl md:text-3xl font-bold text-white underline decoration-blue-600 underline-offset-4 w-max px-2 py-2'}
            >
                GitHub
            </motion.div>
            <motion.div 
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.7, delay: 1.6 }}
              className={'flex flex-col md:flex-row lg:flex-row w-full mt-4 md:mt-8 justify-start items-center space-y-4 md:space-y-0'}
            >
                  <motion.img 
                    whileHover={{ scale: 1.1, rotate: 10 }}
                    transition={{ type: "spring", stiffness: 300 }}
                    src={'https://avatars.githubusercontent.com/u/125345731'} 
                    className={'w-16 h-16 md:w-20 md:h-20 rounded-full flex-shrink-0'} 
                  />
                  <div className={'flex flex-col h-max md:ml-3 pr-3 text-center md:text-left'}>
                      <a href={'https://github.com/nansang2000'} target={'_blank'} rel="noreferrer" className={'w-full'}>
                          <div className={'text-xl md:text-2xl font-thin text-black hover:underline hover:decoration-blue-400'}>
                              nansang2000
                          </div>
                      </a>
                      <div className={'text-base md:text-lg font-thin text-blue-500 font-mono'}>
                           Nan Sang
                      </div>
                  </div>
                  <div className={'w-full md:flex-1'}>
                    <GitHubStats />
                  </div>
            </motion.div>

[//]: # (<img className={'h-32'} src={'https://github-readme-stats-git-masterrstaa-rickstaa.vercel.app/api?username=nansang2000'} alt={'Github'}/>)
            <img className={'mt-6 md:mt-10 w-full'} src="https://ghchart.rshah.org/FF5733/nansang2000" alt="GitHub nansang2000" />
        </div>
    </motion.div>
</motion.div>

export function RunCircle () {
  const ref = useRef(null)
  const { x, y } = useFollowPointer(ref)
  return (
    <>
      <div className={'bg-black bg-black absolute w-full h-full opacity-40 z-10'}></div>
      <motion.div ref={ref}
           animate={{ x, y }}
           transition={{
             type: 'spring',
             damping: 10,
             stiffness: 50,
             restDelta: 0.001
           }}
           className={'bg-purple-900 h-64 w-64 rounded-full absolute top-24 left-24 blur-2xl'}
      />
      <motion.div
            animate={{ x, y }}
            transition={{
              type: 'spring',
              damping: 3,
              stiffness: 50,
              restDelta: 0.001
            }}
            className={'bg-pink-900 h-64 w-64 rounded-full absolute top-16 left-32 blur-2xl'}
      />
    </>
  )
}

<div className={'w-full flex flex-col lg:grid lg:grid-flow-row-dense lg:grid-cols-3 gap-2 my-3'}>
  <div className={'flex relative overflow-hidden bg-black h-96 w-full rounded-2xl'}>
    <RunCircle />
    <div className={'h-full z-10 p-6 grid w-full items-stretch content-start'}>
      <div className={'text-3xl flex h-max justify-center items-center font-bold text-white underline decoration-purple-600 underline-offset-4 w-max px-2 py-2'}>
        Blog
        <Link href={'/blog'} className={'ml-2 rounded-full w-8 h-8 flex justify-center items-center mt-1 '}>
          <FiArrowRight className={'text-2xl text-white'} />
        </Link>
      </div>
      <div className={'flex flex-col lg:flex-row w-full justify-start items-center text-xl ml-2 text-gray-500'}>
        Record my coding experience and life.
      </div>
    </div>
  </div>
  <div className={'flex relative overflow-hidden bg-black h-96 w-full rounded-2xl'}>
    <div className={'h-full z-10 p-6 grid w-full items-stretch content-start'}>
      <div className={'text-3xl flex h-max justify-center items-center  font-bold text-white underline decoration-red-600 underline-offset-4 w-max px-2 py-2'}>
        Notes
        <Link href={'/note'} className={'ml-2 rounded-full w-8 h-8 flex justify-center items-center mt-1 '}>
          <FiArrowRight className={'text-2xl text-white'} />
        </Link>
      </div>
      <div className={'flex flex-col lg:flex-row w-full justify-start items-center text-xl ml-2 text-gray-500'}>
        Record the systematized learning knowledge.
      </div>
      <div className={'mt-3 w-full bg-gray-800 px-3 py-3 bg-opacity-90 rounded-md flex justify-between items-center'}>
        <div className={'text-red-500 font-bold text-base lg:text-lg'}>
          Computer Science
        </div>
        <MdOutlineScience className={'text-2xl text-white'} />
      </div>
      <div className={'mt-3 w-full bg-gray-800 px-3 py-3 bg-opacity-90 rounded-md flex justify-between items-center'}>
        <div className={'text-red-500 font-bold text-base lg:text-lg'}>
          Front End
        </div>
        <FaReact className={'text-2xl text-white'} />
      </div>
      <div className={'mt-3 w-full bg-gray-800 px-3 py-3 bg-opacity-90 rounded-md flex justify-between items-center'}>
        <div className={'text-red-500 font-bold text-base lg:text-lg'}>
          Back End
        </div>
        <SiNestjs className={'text-2xl text-white'} />
      </div>
    </div>
  </div>
  <div className={'flex relative overflow-hidden bg-black h-96 w-full rounded-2xl'}>
    <div className={'h-full z-10 p-6 grid w-full items-stretch content-start'}>
      <div className={'text-3xl flex h-max justify-center items-center font-bold text-white underline decoration-green-300 underline-offset-4 w-max px-2 py-2 z-10'}>
          Curriculum Vitae
        <Link href={'/CurriculumVitae'} className={'ml-2 rounded-full w-8 h-8 flex justify-center items-center mt-1 z-10'}>
          <FiArrowRight className={'text-2xl text-white'} />
        </Link>
      </div>
      <div className={'flex flex-col lg:flex-row w-full justify-start items-center text-xl ml-2 text-gray-500 z-10'}>
        My personal CV.
      </div>
      <div className={'opacity-30 hover:opacity-20 transition-all ease duration-700 absolute -bottom-10 -right-12 z-0'}>
        <Logo height="400" color={'#86EFAC'}/>
      </div>
    </div>
  </div>
</div>

export function TechCards () {
  const [selectedId, setSelectedId] = useState(null)
  const items = [
    {
      id: 1,
      title: 'React',
      subtitle: 'Front End'
    },
    {
      id: 2,
      title: 'NestJS',
      subtitle: 'Back End'
    },
    {
      id: 3,
      title: 'MongoDB',
      subtitle: 'Database'
    }
  ]
  return (
    <>
      {items.map((item, index) => (
        <motion.div key={index} layoutId={item.id} onClick={() => setSelectedId(item.id)}>
          <motion.h5>{item.subtitle}</motion.h5>
          <motion.h2>{item.title}</motion.h2>
        </motion.div>
      ))}

      <AnimatePresence>
        {selectedId && (
          <motion.div layoutId={selectedId}>
            <motion.h5>{items[selectedId].subtitle}</motion.h5>
            <motion.h2>{items[selectedId].title}</motion.h2>
            <motion.button onClick={() => setSelectedId(null)} />
          </motion.div>
        )}
      </AnimatePresence>
    </>
  )
}

<motion.div 
  initial={{ opacity: 0 }}
  animate={{ opacity: 1 }}
  transition={{ duration: 0.8, delay: 2.4 }}
  className={'w-full flex flex-col lg:grid lg:grid-flow-row-dense lg:grid-cols-5 gap-3 md:gap-2 my-3'}
>
  <motion.div 
    whileHover={{ scale: 1.02 }}
    transition={{ type: "spring", stiffness: 300 }}
    className={'flex relative overflow-hidden bg-black col-span-3 h-80 md:h-96 lg:h-96 w-full rounded-2xl'}
  >
    <div className={'bg-black bg-gray-800 absolute w-full h-full opacity-80 z-0 backdrop-blur-lg'}></div>
    <motion.div 
      initial={{ opacity: 0, scale: 0.5 }}
      animate={{ opacity: 0.2, scale: 1 }}
      transition={{ duration: 1.5, delay: 2.6 }}
      className={'w-96 h-96 bg-yellow-800 rounded-full absolute blur-3xl left-24 opacity-20'}
    ></motion.div>
    <motion.div 
      initial={{ opacity: 0, scale: 0.5 }}
      animate={{ opacity: 0.2, scale: 1 }}
      transition={{ duration: 1.5, delay: 2.8 }}
      className={'w-96 h-96 bg-pink-800 rounded-full absolute blur-3xl right-24 opacity-20'}
    ></motion.div>
    <motion.div 
      initial={{ opacity: 0, y: 30 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.8, delay: 3.0 }}
      className={'absolute z-[11] top-24 md:top-32 w-full px-2'}
    >
      <div className={'w-full'}>
        <Stacks stacks={frontEnd} direction={'left'}/>
      </div>
      <div className={'w-full mt-4 md:mt-6'}>
        <Stacks stacks={OtherStacks} direction={'right'}/>
      </div>
    </motion.div>
    <div className={'h-full z-10 p-4 md:p-6 grid w-full items-stretch content-start'}>
      <motion.div 
        initial={{ opacity: 0, y: -20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.5, delay: 2.6 }}
        className={'text-2xl md:text-3xl font-bold text-white underline decoration-pink-600 underline-offset-4'}
      >
        Tech Stack
      </motion.div>
      <motion.div 
        initial={{ opacity: 0, rotate: -10 }}
        animate={{ opacity: 0.1, rotate: 0 }}
        whileHover={{ opacity: 0.2, rotate: 5 }}
        transition={{ duration: 0.7, delay: 3.0 }}
        className={'opacity-10 hover:opacity-20 transition-all ease duration-700 absolute -bottom-12 -right-16 z-0 hidden md:block'}
      >
        <img alt={'tech stack'} src={'/react_ts.svg'} className={'w-96 h-96'} />
      </motion.div>
[//]: # (<TechCards />)
    </div>
  </motion.div>
  <motion.div 
    whileHover={{ scale: 1.02 }}
    transition={{ type: "spring", stiffness: 300 }}
    className={'flex relative overflow-hidden bg-gray-800 col-span-2 h-80 md:h-96 w-full rounded-2xl contact-bg'}
  >
    <div className={'bg-black bg-blue-300 absolute w-full h-full opacity-50 z-0 blur-md'}></div>
    <div className={'h-full z-10 p-4 md:p-6 grid w-full items-stretch content-start'}>
      <div className={'text-2xl md:text-3xl font-bold text-blue-800 underline decoration-blue-800 underline-offset-4'}>
        Contact
      </div>
      <div className={'mt-4 md:mt-3 w-full flex flex-col justify-center items-end space-y-2 md:space-y-1'}>
        <a href={'https://www.linkedin.com/in/nan-sang/'} target={'_blank'} rel="noreferrer" className={'flex w-full justify-end items-center group'}>
          <div className={'text-base md:text-lg lg:text-5xl mr-2 md:mr-3 opacity-0 group-hover:opacity-60 transition-all ease-in-out duration-700 text-white'}>Linkedin</div>
          <img src={'/Linkedin.svg'} className={'w-16 h-16 md:w-20 md:h-20 lg:w-24 lg:h-24 opacity-25 hover:opacity-60 transition-all ease-in-out duration-700'} />
        </a>
        <a href={'https://github.com/nansang2000'} target={'_blank'} rel="noreferrer" className={'flex w-full justify-end items-center group'}>
          <div className={'text-base md:text-lg lg:text-5xl mr-2 md:mr-3 opacity-0 group-hover:opacity-60 transition-all ease-in-out duration-700 text-white'}>GITHUB</div>
          <img src={'/github.svg'} className={'w-16 h-16 md:w-20 md:h-20 lg:w-24 lg:h-24 opacity-25 hover:opacity-60 transition-all ease-in-out duration-700'} />
        </a>
        <a href={'mailto:nansang2000@gmail.com'} target={'_blank'} rel="noreferrer" className={'flex w-full justify-end items-center group'}>
          <div className={'text-base md:text-lg lg:text-5xl mr-2 md:mr-3 opacity-0 group-hover:opacity-60 transition-all ease-in-out duration-700 text-white'}>Gmail</div>
          <img src={'/email.svg'} className={'w-16 h-16 md:w-20 md:h-20 lg:w-24 lg:h-24 opacity-25 hover:opacity-60 transition-all ease-in-out duration-700'} />
        </a>
      </div>
    </div>
  </motion.div>
</motion.div>

export function VistorDemo () {
  const { count, ip, loading, error } = Visitors()
  return (
    <div className="flex flex-col items-center justify-center text-black dark:text-white">
      <div className="text-4xl md:text-5xl lg:text-6xl font-bold">{count}</div>
      <div className="text-base md:text-lg lg:text-xl mt-2">Visitor Count</div>
      {ip && (
        <div className="mt-3 md:mt-4 flex flex-col items-center">
          <div className="text-xs md:text-sm text-gray-600 dark:text-gray-400">最近访问IP</div>
          <div className="text-sm md:text-base lg:text-lg font-medium">{ip}</div>
        </div>
      )}
      {loading && <div className="mt-2 text-xs md:text-sm text-gray-500">加载中...</div>}
      {error && <div className="mt-2 text-xs md:text-sm text-red-500">{error}</div>}
    </div>
  )
}

<motion.div 
  initial={{ opacity: 0 }}
  animate={{ opacity: 1 }}
  transition={{ duration: 0.8, delay: 3.2 }}
  className={'w-full flex flex-col lg:grid lg:grid-flow-row-dense lg:grid-cols-5 gap-3 md:gap-2 my-3'}
>
  <motion.div 
    whileHover={{ scale: 1.02, y: -5 }}
    transition={{ type: "spring", stiffness: 300, damping: 20 }}
    className={'group relative overflow-hidden col-span-2 h-80 md:h-96 w-full rounded-[2rem]'}
  >
    {/* 外层发光边框 */}
    <div className="absolute -inset-0.5 bg-gradient-to-r from-cyan-400 via-blue-500 to-purple-600 rounded-[2rem] opacity-30 group-hover:opacity-50 transition-all duration-500 blur-sm" />
    
    {/* 主容器 - 玻璃拟态 */}
    <div className="relative h-full w-full rounded-[1.8rem] bg-gradient-to-br from-white/20 via-white/10 to-white/5 dark:from-gray-800/25 dark:via-gray-800/15 dark:to-gray-800/5 backdrop-blur-2xl border border-white/30 dark:border-gray-700/30 shadow-2xl overflow-hidden">
      
      {/* 豪华背景装饰 */}
      <motion.div 
        initial={{ opacity: 0, scale: 0.7 }}
        animate={{ opacity: 0.4, scale: 1 }}
        transition={{ duration: 2, delay: 3.4 }}
        className={'absolute -top-20 -right-20 w-56 h-56 bg-gradient-to-br from-cyan-400/40 via-blue-500/35 to-purple-600/30 rounded-full blur-3xl'}
      ></motion.div>
      <motion.div 
        initial={{ opacity: 0, scale: 0.7 }}
        animate={{ opacity: 0.3, scale: 1 }}
        transition={{ duration: 2.5, delay: 3.6 }}
        className={'absolute -bottom-24 -left-24 w-64 h-64 bg-gradient-to-br from-purple-400/30 via-pink-400/25 to-blue-400/20 rounded-full blur-3xl'}
      ></motion.div>
      
      {/* 动态旋转装饰 */}
      <motion.div
        animate={{ 
          rotate: 360,
          scale: [1, 1.1, 1],
        }}
        transition={{ 
          duration: 20, 
          repeat: Infinity, 
          ease: "linear" 
        }}
        className={'absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-40 h-40 bg-gradient-to-br from-cyan-300/20 via-blue-300/15 to-purple-300/10 rounded-full blur-2xl'}
      ></motion.div>
      
      {/* 精美粒子系统 */}
      {[...Array(10)].map((_, i) => (
        <motion.div
          key={i}
          className="absolute w-1 h-1 bg-gradient-to-r from-cyan-400 to-blue-500 rounded-full opacity-60"
          style={{
            left: `${Math.random() * 100}%`,
            top: `${Math.random() * 100}%`,
          }}
          animate={{
            y: [0, -25, 0],
            x: [0, Math.random() * 15 - 7.5, 0],
            opacity: [0.3, 0.8, 0.3],
            scale: [0.5, 1.2, 0.5],
          }}
          transition={{
            duration: 5 + Math.random() * 3,
            repeat: Infinity,
            delay: Math.random() * 4,
            ease: "easeInOut",
          }}
        />
      ))}

      <div className={'h-full z-10 p-4 md:p-6 grid relative w-full items-stretch content-start'}>
        <motion.div 
          initial={{ opacity: 0, y: -25 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.6, delay: 3.4 }}
          className={'flex items-center justify-between mb-4 md:mb-6'}
        >
          <h3 className="text-2xl md:text-3xl font-black bg-gradient-to-r from-cyan-600 via-blue-600 to-purple-600 bg-clip-text text-transparent tracking-tight">
            ✨ Visitors
          </h3>
          <motion.div
            animate={{ 
              scale: [1, 1.3, 1],
              rotate: [0, 180, 360],
              opacity: [0.7, 1, 0.7]
            }}
            transition={{ duration: 3, repeat: Infinity }}
            className="w-4 h-4 bg-gradient-to-r from-cyan-400 to-blue-500 rounded-full shadow-xl shadow-cyan-400/50"
          />
        </motion.div>

        <motion.div
          initial={{ opacity: 0, scale: 0.85 }}
          animate={{ opacity: 1, scale: 1 }}
          transition={{ duration: 0.8, delay: 3.6 }}
          className="w-full flex-1 flex items-center justify-center"
        >
          <VisitorCard showTitle={false} compact={true} className="w-full h-full" />
        </motion.div>
      </div>
    </div>
  </motion.div>
  <motion.div 
    whileHover={{ scale: 1.02 }}
    transition={{ type: "spring", stiffness: 300 }}
    className={'flex relative overflow-hidden bg-gray-200 col-span-3 h-96 lg:h-96 w-full rounded-2xl'}
  >
    <motion.div 
      initial={{ opacity: 0 }}
      animate={{ opacity: 0.8 }}
      transition={{ duration: 1, delay: 3.4 }}
      className={'bg-white absolute w-full h-full opacity-80 z-0 backdrop-blur-lg'}
    ></motion.div>
    <motion.div 
      initial={{ opacity: 0, scale: 0.5 }}
      animate={{ opacity: 0.2, scale: 1 }}
      transition={{ duration: 1.5, delay: 3.6 }}
      className={'w-96 h-96 bg-red-800 rounded-full absolute blur-3xl left-24 opacity-20'}
    ></motion.div>
    <motion.div 
      initial={{ opacity: 0, scale: 0.5 }}
      animate={{ opacity: 0.2, scale: 1 }}
      transition={{ duration: 1.5, delay: 3.8 }}
      className={'w-96 h-96 bg-purple-800 rounded-full absolute blur-3xl right-24 opacity-20'}
    ></motion.div>
    <motion.div 
      initial={{ opacity: 0, y: 30 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.8, delay: 4.0 }}
      className={'absolute z-[11] top-32 p-6 w-full'}
    >
      <TextTurn />
    </motion.div>
    <div className={'h-full z-10 p-6 grid w-full items-stretch content-start'}>
      <motion.div 
        initial={{ opacity: 0, y: -20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.5, delay: 3.6 }}
        className={'text-3xl font-bold text-black underline decoration-cyan-600 underline-offset-4'}
      >
        Projects
      </motion.div>
      <motion.div 
        initial={{ opacity: 0, rotate: -10 }}
        animate={{ opacity: 0.1, rotate: 0 }}
        whileHover={{ opacity: 0.2, rotate: 5 }}
        transition={{ duration: 0.7, delay: 4.0 }}
        className={'opacity-10 hover:opacity-20 transition-all ease duration-700 absolute -bottom-12 -right-16 z-0'}
      >
        <img alt={'tech stack'} src={'/stack/html.svg'} className={'w-96 h-96'} />
      </motion.div>
    </div>
  </motion.div>
</motion.div>


